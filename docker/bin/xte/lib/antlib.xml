<?xml version="1.0" encoding="UTF-8"?>
<antlib xmlns:antlib="antlib:org.apache.tools.ant" xmlns:if="ant:if" xmlns:unless="ant:unless">

    <!--
      Macro: select-files
      - Computes includes_file_present based on an includes file path
      - Defines a fileset with either includesfile or a glob pattern

      Attributes:
        dir          : Base directory for fileset
        pattern      : Glob for files when includes file is absent (default: *.xml)
        includes_file: Path to includes file (default matches current build's default)
        filesetid    : ID to assign to the created fileset (default: original_xml)
    -->
    <macrodef name="select-files">
        <attribute name="dir"/>
        <attribute name="pattern" default="*.xml"/>
        <attribute name="includesFile" default="/tmp/opt/cdcp/includes.txt"/>
        <attribute name="filesetId" default="original_xml"/>
        <sequential>
            <!-- Determine if the includes file exists -->
            <available file="@{includesFile}" property="includes_file_present"/>

            <!-- Define the fileset for downstream tasks -->
            <fileset id="@{filesetId}" dir="@{dir}">
                <patternset>
                    <includesfile name="@{includesFile}" if:true="${includes_file_present}"/>
                    <include name="@{pattern}" unless:true="${includes_file_present}"/>
                </patternset>
            </fileset>
        </sequential>
    </macrodef>

    <!--
      Macro: xslt-transform
      - Transforms files from a fileset using a given XSLT
      - Optionally expands schema default attributes via Saxon feature

      Attributes:
        dest                   : Destination directory for transformed output
        xslt                   : Path to the XSLT stylesheet entrypoint
        extension              : Output file extension (e.g., .xml, .html)
        filesetrefid           : RefID of the input fileset to transform
        expand-default-attributes: Toggle expansion of schema default attributes (true/false)
    -->
    <macrodef name="xslt-transform">
        <attribute name="dest"/>
        <attribute name="xslt"/>
        <attribute name="extension"/>
        <attribute name="filesetrefid"/>
        <attribute name="expand-default-attributes"/>

        <sequential>
            <fileset id="files" refid="@{filesetrefid}"/>

            <condition property="files.for.processing" value="true" else="false">
                <length string="${toString:files}" when="greater" length="0"/>
            </condition>

            <echo level="error" message="ERROR: No files to transform in @{filesetrefid}"
                unless:true="${files.for.processing}"/>

            <sequential if:true="${files.for.processing}">
                <echo level="info" message="INFO: Using ${XSLT_ENTRYPOINT}"/>
                
                <condition property="debug.enabled" value="true" else="false">
                    <equals arg1="${ANT_LOG_LEVEL}" arg2="debug" trim="true"/>
                </condition>
                <sequential if:true="${debug.enabled}">
                    <pathconvert property="files.list" pathsep=", ">
                        <resources refid="files"/>
                    </pathconvert>
                    <echo level="debug" message="DEBUG: Files: ${files.list}"/>
                </sequential>
        
                <echo level="info" message="INFO: No expansion of default attributes defined in the schema" unless:true="${expand-default-attributes}"/>
                <echo level="info" message="INFO: Default attributes defined in the schema expanded" if:true="${expand-default-attributes}"/>


                <xslt destdir="@{dest}" style="@{xslt}" force="true" useimplicitfileset="false"
                    extension="@{extension}" reloadstylesheet="true"
                    unless:true="@{expand-default-attributes}" failOnError="false"
                    failOnTransformationError="false">
                    <fileset refid="@{filesetrefid}"/>
                    <factory name="net.sf.saxon.BasicTransformerFactory">
                        <attribute name="http://saxon.sf.net/feature/xinclude-aware" value="true"/>
                        <attribute name="http://saxon.sf.net/feature/expandAttributeDefaults"
                            value="off"/>
                    </factory>
                    <param name="fragment-output-dir" expression="${fragment-output-dir}"/>
                </xslt>

                <xslt destdir="@{dest}" style="@{xslt}" force="true" useimplicitfileset="false"
                    extension="@{extension}" reloadstylesheet="true"
                    if:true="@{expand-default-attributes}" failOnError="false"
                    failOnTransformationError="false">
                    <fileset refid="@{filesetrefid}"/>
                    <factory name="net.sf.saxon.BasicTransformerFactory">
                        <attribute name="http://saxon.sf.net/feature/xinclude-aware" value="true"/>
                    </factory>
                    <param name="fragment-output-dir" expression="${fragment-output-dir}"/>
                </xslt>
            </sequential>
        </sequential>
    </macrodef>
</antlib>
