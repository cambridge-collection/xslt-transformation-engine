<?xml version="1.0" encoding="UTF-8"?>
<project name="TranformsXml" basedir=".." default="full"
    xmlns:if="ant:if"
    xmlns:unless="ant:unless"
    xmlns:fs="antlib:cudl.fs">
    <dirname property="buildfile.dir" file="${ant.file}"/>

    <property environment="env"/>
    <property name="ENVIRONMENT" value="${env.ENVIRONMENT}"/>
    <property name="ANT_LOG_LEVEL" value="${env.ANT_LOG_LEVEL}"/>

    <!-- Load reusable xte macros -->
    <typedef file="${basedir}/bin/xte/lib/antlib.xml" uri="antlib:cudl.fs"/>

    <!-- The following switches can be passed when invoking ant to provide custom values -->
    <property name="data.dir"  location="./source"/><!-- Source of the original data files -->
    <property name="dist.dir"  location="./out"/><!-- Final dist dir (standalone build only) -->

    <property name="dist-pending.dir"  location="./dist-pending"/><!-- Initial output directory -->
    
    <condition property="files-to-process" value="${env.TEI_FILE}" else="*.xml"><!-- File(s) to build -->
        <isset property="env.TEI_FILE"/>
    </condition>
    <property name="includes_file" value="/tmp/opt/cdcp/includes.txt"/><!-- Default path for includes file; overridden by -Dincludes_file -->

    <property name="tmp.dir"  location="./tmp"/><!-- Target directory for the TEI XML page extract files -->
    <property name="dev.null"  location="./dev.null"/><!-- Destination directory for empty junk files created by ant's xslt task when running pagify.xsl -->

    <!-- Final S3 Destinations -->
    <property name="AWS_OUTPUT_BUCKET" value="${env.AWS_OUTPUT_BUCKET}"/>

    <!-- XSLT File to use -->
    <property name="XSLT_ENTRYPOINT" value="${env.XSLT_ENTRYPOINT}"/>
    <property name="OUTPUT_EXTENSION" value="${env.OUTPUT_EXTENSION}"/>
    <property name="EXPAND_DEFAULT_ATTRIBUTES" value="${env.EXPAND_DEFAULT_ATTRIBUTES}"/>

    <!-- Comprehensive builds -->

    <target name="full" depends="cleanup, run.prehook, transcripts">
        <antcall target="release-outputs"/>
        <antcall target="cleanup"/>
    </target>

    <target name="transcripts" depends="if.expand-default-attributes, cleanup">
        <!-- Compute includes_file_present and define fileset -->
        <fs:select-files dir="${data.dir}" pattern="${files-to-process}" includesFile="${includes_file}" filesetId="original_xml"/>

        <fs:xslt-transform filesetrefid="original_xml" 
                           xslt="./${XSLT_ENTRYPOINT}" 
                           extension=".${OUTPUT_EXTENSION}"
                           dest="${dist-pending.dir}"
                           expand-default-attributes="${expand-default-attributes}" />
    
    </target>

     <!-- Private tasks called from main tasks -->

    <target name="release-outputs" depends="if.standalone.environment">
        <antcall target="run.posthook"/>
        <antcall if:true="${is.standalone.environment}" target="_copy_to_dist"/>
        <antcall unless:true="${is.standalone.environment}" target="_copy_to_s3"/>
    </target>

    <target name="_copy_to_dist">
        <copy todir="${dist.dir}">
            <fileset dir="${dist-pending.dir}">
                <include name="**/*"/>
            </fileset>
        </copy>
    </target>

    <target name="_copy_to_s3">
        <parallel>
            <!-- NB: Uncomment the following line to copy original TEI to dist -->
            <!--<antcall target="_copy_tei_full_to_s3"/>-->
            <antcall target="_copy_www_to_s3"/>
        </parallel>
    </target>

    <target name="_copy_www_to_s3">
        <condition property="www.exists" value="true" else="false">
            <available file="${dist-pending.dir}" type="dir"/>
        </condition>
        <echo level="info" if:true="${www.exists}" message="INFO: Copying ${dist-pending.dir} to S3://${AWS_OUTPUT_BUCKET}"/>
        <exec if:true="${www.exists}" executable="aws" resolveexecutable="true">
            <arg value="s3"/>
            <arg value="sync"/>
            <arg value="--quiet"/>
            <arg value="${dist-pending.dir}"/>
            <arg value="s3://${AWS_OUTPUT_BUCKET}"/>
        </exec>
    </target>

    <target name="if.standalone.environment">
        <condition property="is.standalone.environment" value="true" else="false">
            <equals arg1="${ENVIRONMENT}" arg2="standalone" trim="true"/>
        </condition>
    </target>

    <target name="if.expand-default-attributes">
        <condition property="expand-default-attributes" value="true" else="false">
            <equals arg1="${EXPAND_DEFAULT_ATTRIBUTES}" arg2="true" trim="true"/>
        </condition>
    </target>

    <!-- Handle pre.hook -->
    <target name="run.prehook">
        <run-hook
            label="pre"
            script="/var/task/pre.sh"
            argdir="${data.dir}"/>
    </target>

    <!-- Handle post.hook -->
    <target name="run.posthook">
        <run-hook
            label="post"
            script="/var/task/post.sh"
            argdir="${dist-pending.dir}"/>
    </target>

    <target name="cleanup">
        <echo level="info">INFO: Cleaning up previous build results</echo>
        <retry retrycount="6">
            <delete dir="${tmp.dir}" failonerror="no" />
        </retry>
        <retry retrycount="6">
            <delete dir="${dev.null}" failonerror="no" />
        </retry>
        <retry retrycount="6">
            <delete dir="${dist-pending.dir}" failonerror="no"/>
        </retry>
        <mkdir dir="${dist-pending.dir}"/>
    </target>

        <!-- Macro to run pre/post hook scripts with minimal duplication -->
    <macrodef name="run-hook">
        <attribute name="label"/><!-- e.g. pre | post (for logging) -->
        <attribute name="script"/><!-- absolute path to hook script -->
        <attribute name="argdir"/><!-- directory passed as first arg to script -->
        <sequential>
            <!-- Check presence of the hook script -->
            <available file="@{script}" property="@{label}hook.present" value="true"/>

            <!-- Build fileset from includes and current filter -->
            <fs:requested-files files="${files-to-process}" includesFile="${includes_file}" property="@{label}hook_fs"/>

            <!-- Informational logging -->
            <echo level="info" if:true="${@{label}hook.present}">INFO: Running @{label}.hook</echo>
            <echo level="info" unless:true="${@{label}hook.present}">INFO: No @{label}.hook</echo>

            <!-- Create temp includes file listing selected inputs -->
            <tempfile if:true="${@{label}hook.present}" property="@{label}hook.includes.file" destdir="${java.io.tmpdir}" prefix="includes-@{label}-" suffix=".txt" deleteonexit="true"/>
            <echo if:true="${@{label}hook.present}" file="${@{label}hook.includes.file}" message="${@{label}hook_fs}"/>

            <!-- Execute hook script -->
            <exec if:true="${@{label}hook.present}" executable="@{script}" resolveexecutable="true" failonerror="true">
                <arg value="@{argdir}"/>
                <arg value="--includes-file"/>
                <arg value="${@{label}hook.includes.file}"/>
            </exec>
            <delete if:true="${@{label}hook.present}" file="${@{label}hook.includes.file}" quiet="true"/>
        </sequential>
    </macrodef>

</project>
